version: '3.9'

services:
  # ============= POSTGRESQL DATABASE =============
  postgres:
    image: postgres:15-alpine
    container_name: vehicle-inspection-postgres
    environment:
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-databases.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-admin}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - inspection-network
    restart: unless-stopped

  # ============= AUTHORIZATION SERVICE =============
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-auth
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_EXPIRATION_HOURS: ${JWT_EXPIRATION_HOURS:-24}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_AUTH: ${DB_NAME_AUTH:-auth_db}
      LOGGING_SERVICE_URL: http://logging-service:8005
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${AUTH_SERVICE_PORT:-8001}:8001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= APPOINTMENT SERVICE =============
  appointment-service:
    build:
      context: ./backend/appointment-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-appointment
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_APPOINTMENTS: ${DB_NAME_APPOINTMENTS:-appointments_db}
      LOGGING_SERVICE_URL: http://logging-service:8005
      PAYMENT_SERVICE_URL: http://payment-service:8003
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${APPOINTMENT_SERVICE_PORT:-8002}:8002"
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= PAYMENT SERVICE =============
  payment-service:
    build:
      context: ./backend/payment-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-payment
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_PAYMENTS: ${DB_NAME_PAYMENTS:-payments_db}
      LOGGING_SERVICE_URL: http://logging-service:8005
      APPOINTMENT_SERVICE_URL: http://appointment-service:8002
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${PAYMENT_SERVICE_PORT:-8003}:8003"
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= INSPECTION SERVICE =============
  inspection-service:
    build:
      context: ./backend/inspection-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-inspection
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_INSPECTIONS: ${DB_NAME_INSPECTIONS:-inspections_db}
      LOGGING_SERVICE_URL: http://logging-service:8005
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${INSPECTION_SERVICE_PORT:-8004}:8004"
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= LOGGING SERVICE =============
  logging-service:
    build:
      context: ./backend/logging-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-logging
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_LOGS: ${DB_NAME_LOGS:-logs_db}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${LOGGING_SERVICE_PORT:-8005}:8005"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= NOTIFICATION SERVICE =============
  notification-service:
    build:
      context: ./backend/notification-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-notification
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_NOTIFICATIONS: ${DB_NAME_NOTIFICATIONS:-notifications_db}
      LOGGING_SERVICE_URL: http://logging-service:8005
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-8006}:8006"
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= FILE SERVICE =============
  file-service:
    build:
      context: ./backend/file-service
      dockerfile: Dockerfile
    container_name: vehicle-inspection-file
    environment:
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      DB_NAME_FILES: ${DB_NAME_FILES:-files_db}
      UPLOAD_DIR: /app/uploads
      LOGGING_SERVICE_URL: http://logging-service:8005
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${FILE_SERVICE_PORT:-8007}:8007"
    volumes:
      - file_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============= FRONTEND SERVICE =============
  frontend:
    image: nginx:alpine
    container_name: vehicle-inspection-frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${UI_SERVICE_PORT:-3000}:80"
    depends_on:
      - auth-service
      - appointment-service
      - payment-service
      - inspection-service
      - logging-service
    networks:
      - inspection-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  file_uploads:
    driver: local

networks:
  inspection-network:
    driver: bridge