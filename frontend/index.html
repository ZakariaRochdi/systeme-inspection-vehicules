<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centre de Contr√¥le Technique Automobile</title>
    <style>
        /* Nouveau th√®me: Violet/Indigo profond au lieu de turquoise */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1F2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: #6366F1;
            font-size: 28px;
            font-weight: 700;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            display: none;
        }

        .notification-badge.active {
            display: block;
        }

        button {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        button.logout {
            background: #ff6b6b;
        }

        button.logout:hover {
            background: #ff5252;
        }

        .upload-area {
            border: 3px dashed #6366F1;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: #F8FAFC;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #EEF2FF;
            border-color: #8B5CF6;
        }

        .upload-area.dragover {
            background: #d4edda;
            border-color: #28a745;
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .file-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-preview-item .remove-file {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            margin-bottom: 25px;
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
            transform: translateY(-3px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #F8FAFC;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group button {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .badge.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #6366F1;
            background: white;
        }

        .checkbox-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.4);
        }

        .stat-card h3 {
            color: white;
            font-size: 38px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            color: rgba(255,255,255,0.9);
            font-size: 15px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6366F1;
        }

        .spinner {
            border: 5px solid #E5E7EB;
            border-top: 5px solid #6366F1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid,
            .form-row,
            .checkbox-group {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                width: 100%;
            }

            .nav-buttons button {
                flex: 1;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .badge.not_checked {
            background: #e7f3ff;
            color: #004085;
        }

        .badge.in_progress {
            background: #fff3cd;
            color: #856404;
        }

        .badge.passed {
            background: #d4edda;
            color: #155724;
        }

        .badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.passed_with_minor_issues {
            background: #fff3cd;
            color: #856404;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }

        button:disabled:hover {
            background: #ccc !important;
            transform: none;
            box-shadow: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .admin-tab {
            min-height: 300px;
        }

        .badge.customer {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.technician {
            background: #fff3cd;
            color: #856404;
        }

        .badge.admin {
            background: #f8d7da;
            color: #721c24;
        }

        .pagination {
            display: inline-flex;
            gap: 5px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="main-header" id="mainHeader" style="display: none;">
        <div class="logo">
            <div class="logo-icon">üöó</div>
            <div>
                <h1>Centre de Contr√¥le Technique</h1>
                <div class="user-info" id="userInfo"></div>
            </div>
        </div>
        <div class="nav-buttons">
            <button id="navDashboard" onclick="navigateTo('dashboard')" style="display: none;">üìä Tableau de Bord</button>
            <button id="navAppointments" onclick="navigateTo('appointments')" style="display: none;">üìÖ Rendez-vous</button>
            <button id="navStatus" onclick="navigateTo('status')" style="display: none;">üìã Mes R√©sultats</button>
            <button id="navInspection" onclick="navigateTo('inspection')" style="display: none;">üîß Inspections</button>
            <button id="navAdmin" onclick="navigateTo('admin')" style="display: none;">‚öôÔ∏è Administration</button>
            <div class="notification-bell" onclick="openNotifications()" id="notificationBell" style="display: none;">
                üîî
                <span class="notification-badge" id="notificationBadge"></span>
            </div>
            <button class="logout" onclick="logout()">üö™ D√©connexion</button>
        </div>
    </header>

    <div class="container">
        <!-- Auth Pages -->
        <div id="loginPage" class="page active">
            <div class="card" style="max-width: 450px; margin: 100px auto;">
                <h2 style="margin-bottom: 30px; text-align: center; color: #6366F1; font-weight: 700;">üîê Connexion</h2>
                <div id="loginAlert" class="alert"></div>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Adresse Email</label>
                        <input type="email" id="loginEmail" required placeholder="votre@email.com">
                    </div>
                    <div class="form-group">
                        <label>Mot de Passe</label>
                        <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group" style="padding: 18px; background: #F8FAFC; border: 2px solid #E5E7EB; border-radius: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="loginRecaptcha" required style="width: auto; margin-right: 12px;">
                            <span>Je ne suis pas un robot (reCAPTCHA)</span>
                        </label>
                        <small style="color: #6B7280; margin-top: 8px; display: block;">‚úÖ En production, ceci sera remplac√© par Google reCAPTCHA v2</small>
                    </div>
                    <button type="submit" style="width: 100%; margin-bottom: 12px;">Se Connecter</button>
                    <button type="button" onclick="navigateTo('register')" style="width: 100%; background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);">Cr√©er un Compte</button>
                </form>
            </div>
        </div>

        <div id="registerPage" class="page">
            <div class="card" style="max-width: 700px; margin: 50px auto;">
                <h2 style="margin-bottom: 30px; text-align: center; color: #6366F1; font-weight: 700;">üìù Cr√©er un Compte</h2>
                <div id="registerAlert" class="alert"></div>
                <form onsubmit="handleRegister(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pr√©nom (Optionnel)</label>
                            <input type="text" id="registerFirstName" minlength="2" placeholder="Jean">
                        </div>
                        <div class="form-group">
                            <label>Nom (Optionnel)</label>
                            <input type="text" id="registerLastName" minlength="2" placeholder="Dupont">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Adresse Email *</label>
                        <input type="email" id="registerEmail" required placeholder="votre@email.com">
                    </div>
                    <div class="form-group">
                        <label>Mot de Passe * (minimum 8 caract√®res)</label>
                        <input type="password" id="registerPassword" required minlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date de Naissance (Optionnel - 18+ requis)</label>
                            <input type="date" id="registerBirthdate" max="9999-12-31">
                        </div>
                        <div class="form-group">
                            <label>N¬∞ Carte d'Identit√©/Passeport (Optionnel)</label>
                            <input type="text" id="registerIdNumber" minlength="5" placeholder="ex: AB123456">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pays (Optionnel)</label>
                            <input type="text" id="registerCountry" placeholder="ex: France">
                        </div>
                        <div class="form-group">
                            <label>R√©gion/Province (Optionnel)</label>
                            <input type="text" id="registerState" placeholder="ex: √éle-de-France">
                        </div>
                    </div>
                    <div class="form-group" style="display: none;">
                        <label>Role</label>
                        <select id="registerRole">
                            <option value="customer" selected>Customer</option>
                        </select>
                    </div>
                    <div class="alert info" style="display: block; margin-bottom: 18px;">
                        ‚ÑπÔ∏è L'inscription publique est r√©serv√©e aux clients. Les comptes techniciens doivent √™tre cr√©√©s par un administrateur.
                    </div>
                    <div class="form-group" style="padding: 18px; background: #F8FAFC; border: 2px solid #E5E7EB; border-radius: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="registerRecaptcha" required style="width: auto; margin-right: 12px;">
                            <span>Je ne suis pas un robot (reCAPTCHA)</span>
                        </label>
                        <small style="color: #6B7280; margin-top: 8px; display: block;">‚úÖ En production, ceci sera remplac√© par Google reCAPTCHA v2</small>
                    </div>
                    <button type="submit" style="width: 100%; margin-bottom: 12px;">S'Inscrire</button>
                    <button type="button" onclick="navigateTo('login')" style="width: 100%; background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);">Retour √† la Connexion</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Pages -->
        <div id="dashboardPage" class="page">
            <div class="card">
                <h2>üìä Tableau de Bord</h2>
                <div id="dashboardContent"></div>
            </div>
        </div>

        <!-- Customer Appointments -->
        <div id="appointmentsPage" class="page">
            <div class="card">
                <h2>üìÖ R√©server un Rendez-vous</h2>
                <div id="appointmentAlert" class="alert"></div>
                <form onsubmit="handleBookAppointment(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type de V√©hicule</label>
                            <select id="vehicleType" required>
                                <option value="">S√©lectionner un type</option>
                                <option value="car">Voiture</option>
                                <option value="motorcycle">Moto</option>
                                <option value="truck">Camion</option>
                                <option value="van">Fourgonnette</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Num√©ro d'Immatriculation</label>
                            <input type="text" id="vehicleReg" placeholder="ex: AB-123-CD" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Marque</label>
                            <input type="text" id="vehicleBrand" placeholder="ex: Renault" required>
                        </div>
                        <div class="form-group">
                            <label>Mod√®le</label>
                            <input type="text" id="vehicleModel" placeholder="ex: Clio" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Date du Rendez-vous</label>
                        <input type="datetime-local" id="appointmentDate">
                    </div>
                    <button type="submit">R√©server le Rendez-vous</button>
                </form>
            </div>

            <div class="card">
                <h2>Vos Rendez-vous</h2>
                <div id="appointmentsList"></div>
            </div>
        </div>

        <!-- Customer Status/Results Page -->
        <div id="statusPage" class="page">
            <div class="card">
                <h2>üìã Mes R√©sultats de Contr√¥le</h2>
                <p style="color: #6B7280; margin-bottom: 20px;">Consultez le statut et les r√©sultats de vos contr√¥les techniques</p>
                <div id="statusAlert" class="alert"></div>
                <div id="customerStatusList"></div>
            </div>
        </div>

        <!-- Technician Inspection -->
        <div id="inspectionPage" class="page">
            <div class="card">
                <h2>üîß Soumettre les R√©sultats du Contr√¥le</h2>
                <div id="inspectionAlert" class="alert"></div>
                <form onsubmit="handleSubmitInspection(event)">
                    <div class="form-group">
                        <label>ID du Rendez-vous</label>
                        <input type="text" id="inspectionAppId" required placeholder="Entrez l'ID">
                    </div>

                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: #6366F1;">Points de Contr√¥le</h3>
                    <div class="checkbox-group">
                        <div>
                            <label style="margin-bottom: 10px;">Freins</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="brakes" value="PASS" required> Conforme
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="brakes" value="FAIL"> Non Conforme
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">√âclairage</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="lights" value="PASS" required> Conforme
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="lights" value="FAIL"> Non Conforme
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">Pneumatiques</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="tires" value="PASS" required> Conforme
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="tires" value="FAIL"> Non Conforme
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">√âmissions</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="emissions" value="PASS" required> Conforme
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="emissions" value="FAIL"> Non Conforme
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 25px;">
                        <label>R√©sultat Global</label>
                        <select id="finalStatus" required>
                            <option value="">S√©lectionner le r√©sultat</option>
                            <option value="passed">Favorable</option>
                            <option value="failed">D√©favorable</option>
                            <option value="in_progress">En Cours (Sauvegarder & Continuer)</option>
                            <option value="passed_with_minor_issues">Favorable avec R√©serves Mineures</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Observations</label>
                        <textarea id="inspectionNotes" rows="4" placeholder="Observations compl√©mentaires..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>üì∑ T√©l√©charger des Photos du V√©hicule</label>
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <p style="margin: 0; color: #6B7280;">
                                üìÅ Cliquez pour t√©l√©charger ou glissez-d√©posez des photos<br>
                                <small>Formats support√©s: JPG, PNG, GIF, WEBP (Max 10MB chacun)</small>
                            </p>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                        <div id="filePreview" class="file-preview"></div>
                    </div>

                    <button type="submit">Soumettre le Contr√¥le</button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminPage" class="page">
            <div class="card">
                <h2>‚öôÔ∏è Tableau de Bord Administrateur</h2>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 3px solid #E5E7EB; padding-bottom: 10px; flex-wrap: wrap;">
                    <button id="tabUsers" onclick="showAdminTab('users')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üë• Utilisateurs</button>
                    <button id="tabLogs" onclick="showAdminTab('logs')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üìã Journaux</button>
                    <button id="tabVehicles" onclick="showAdminTab('vehicles')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üöó V√©hicules</button>
                    <button id="tabAppointments" onclick="showAdminTab('appointments')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üìÖ Rendez-vous</button>
                    <button id="tabInspections" onclick="showAdminTab('inspections')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üîç Contr√¥les</button>
                    <button id="tabSchedule" onclick="showAdminTab('schedule')" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);">üìÜ Planning</button>
                </div>
                
                <!-- Users Tab -->
                <div id="adminUsersTab" class="admin-tab">
                    <h3>Gestion des Utilisateurs</h3>
                    <button onclick="showCreateUserModal()" style="margin-bottom: 20px;">‚ûï Cr√©er un Technicien</button>
                    <div id="adminUsersList"></div>
                </div>
                
                <!-- Logs Tab -->
                <div id="adminLogsTab" class="admin-tab" style="display: none;">
                    <h3>System Logs</h3>
                    <div class="stats" id="adminStats"></div>
                    
                    <!-- Search/Filter Section -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h4 style="margin-top: 0;">üîç Search & Filter</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Search Message</label>
                                <input type="text" id="logSearchInput" placeholder="Search in messages..." 
                                    onkeyup="applyLogFilters()"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Service</label>
                                <select id="logServiceFilter" onchange="applyLogFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">All Services</option>
                                    <option value="AuthService">Auth Service</option>
                                    <option value="AppointmentService">Appointment Service</option>
                                    <option value="PaymentService">Payment Service</option>
                                    <option value="InspectionService">Inspection Service</option>
                                    <option value="LoggingService">Logging Service</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Level</label>
                                <select id="logLevelFilter" onchange="applyLogFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">All Levels</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="applyLogFilters()" style="margin-top: 15px; padding: 10px 20px;">
                            üîç Apply Filters
                        </button>
                        <button onclick="clearLogFilters()" style="margin-top: 15px; margin-left: 10px; padding: 10px 20px; background: #6c757d;">
                            ‚úñÔ∏è Clear
                        </button>
                    </div>
                    
                    <div id="adminLogs"></div>
                </div>
                
                <!-- Vehicles Tab -->
                <div id="adminVehiclesTab" class="admin-tab" style="display: none;">
                    <h3>All Vehicles</h3>
                    <p style="color: #666; margin-bottom: 20px;">Complete list of all vehicles in the system with their inspection status</p>
                    <div id="adminVehiclesList"></div>
                </div>
                
                <!-- Appointments Tab -->
                <div id="adminAppointmentsTab" class="admin-tab" style="display: none;">
                    <h3>All Appointments</h3>
                    <div id="adminAppointmentsList"></div>
                </div>
                
                <!-- Inspections Tab (NEW!) -->
                <div id="adminInspectionsTab" class="admin-tab" style="display: none;">
                    <h3>üîç All Inspections</h3>
                    <p style="color: #666; margin-bottom: 20px;">View all vehicle inspections with details and results</p>
                    <div id="adminInspectionsList"></div>
                </div>
                
                <!-- Schedule Tab -->
                <div id="adminScheduleTab" class="admin-tab" style="display: none;">
                    <h3>Weekly Schedule</h3>
                    <p style="color: #666; margin-bottom: 20px;">View the same schedule that customers see for booking appointments</p>
                    <div id="adminScheduleView"></div>
                </div>
            </div>
        </div>

        <!-- Create User Modal -->
        <div id="createUserModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeCreateUserModal()">&times;</span>
                <h2>Create Technician Account</h2>
                <div id="createUserAlert" class="alert"></div>
                <form onsubmit="handleCreateTechnician(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name (Optional)</label>
                            <input type="text" id="newTechFirstName" minlength="2" placeholder="Jane">
                        </div>
                        <div class="form-group">
                            <label>Last Name (Optional)</label>
                            <input type="text" id="newTechLastName" minlength="2" placeholder="Smith">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="newTechEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password * (minimum 8 characters)</label>
                        <input type="password" id="newTechPassword" required minlength="8">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth (Optional)</label>
                            <input type="date" id="newTechBirthdate" max="9999-12-31">
                        </div>
                        <div class="form-group">
                            <label>ID/Passport Number (Optional)</label>
                            <input type="text" id="newTechIdNumber" minlength="5" placeholder="TECH123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Country (Optional)</label>
                            <input type="text" id="newTechCountry" placeholder="France">
                        </div>
                        <div class="form-group">
                            <label>State/Province (Optional)</label>
                            <input type="text" id="newTechState" placeholder="Paris">
                        </div>
                    </div>
                    <button type="submit" style="width: 100%;">Create Technician</button>
                </form>
            </div>
        </div>

        <!-- Change Role Modal -->
        <div id="changeRoleModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeChangeRoleModal()">&times;</span>
                <h2>Change User Role</h2>
                <div id="changeRoleAlert" class="alert"></div>
                <div id="changeRoleContent"></div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePaymentModal()">&times;</span>
                <h2>üí≥ Payment Required</h2>
                <div id="paymentAlert" class="alert"></div>
                <p>Inspection fee: <strong>$50.00</strong></p>
                <p style="margin-bottom: 20px;">Appointment ID: <span id="paymentAppointmentId"></span></p>
                <div class="alert info" style="display: block; margin-bottom: 15px;">
                    ‚ÑπÔ∏è This is a simulated payment for educational purposes only. No real money will be charged.
                </div>
                <button onclick="processPayment()" style="width: 100%;">‚úÖ Confirm Payment (Simulated)</button>
            </div>
        </div>

        <!-- Notifications Modal (NEW FEATURE!) -->
        <div id="notificationsModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeNotifications()">&times;</span>
                <h2>üîî Notifications</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="markAllNotificationsRead()" style="background: #6c757d;">Mark All as Read</button>
                </div>
                <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Loading notifications...</p>
                </div>
            </div>
        </div>

        <!-- Inspection Details Modal (NEW FEATURE!) -->
        <div id="inspectionDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeInspectionDetails()">&times;</span>
                <h2>üîç Inspection Details</h2>
                <div id="inspectionDetailsContent" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Loading...</p>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button id="downloadPdfBtn" onclick="downloadCurrentInspectionPDF()" style="background: #ff6b6b;">üìÑ Download PDF Report</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= API CONFIGURATION =============
        const API_BASE = 'http://localhost';
        const SERVICES = {
            auth: `${API_BASE}:8001`,
            appointment: `${API_BASE}:8002`,
            payment: `${API_BASE}:8003`,
            inspection: `${API_BASE}:8004`,
            logging: `${API_BASE}:8005`,
            notification: `${API_BASE}:8006`,
            file: `${API_BASE}:8007`
        };

        let currentUser = null;
        let currentToken = null;

        // ============= PAGE NAVIGATION =============
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById(page + 'Page');
            if (pageEl) {
                pageEl.classList.add('active');
                
                // Load page-specific data
                if (page === 'appointments' && currentUser?.role === 'customer') {
                    loadAppointments();
                } else if (page === 'status' && currentUser?.role === 'customer') {
                    loadCustomerStatus();
                } else if (page === 'admin' && currentUser?.role === 'admin') {
                    loadAdminDash();
                } else if (page === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        // ============= AUTHENTICATION =============
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const alert = document.getElementById('loginAlert');

            try {
                const response = await fetch(`${SERVICES.auth}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(alert, data.detail || 'Login failed', 'error');
                    return;
                }

                currentToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('token', currentToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                showAlert(alert, 'Login successful!', 'success');
                setupUI();
                setTimeout(() => navigateTo('dashboard'), 1000);
            } catch (error) {
                showAlert(alert, 'Connection error: ' + error.message, 'error');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const birthdate = document.getElementById('registerBirthdate').value;
            const country = document.getElementById('registerCountry').value;
            const state = document.getElementById('registerState').value;
            const idNumber = document.getElementById('registerIdNumber').value;
            const alert = document.getElementById('registerAlert');

            try {
                const response = await fetch(`${SERVICES.auth}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        role,
                        first_name: firstName,
                        last_name: lastName,
                        birthdate,
                        country,
                        state,
                        id_number: idNumber
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Better error handling
                    let errorMsg = 'Registration failed';
                    if (typeof data.detail === 'string') {
                        errorMsg = data.detail;
                    } else if (data.detail && typeof data.detail === 'object') {
                        errorMsg = JSON.stringify(data.detail);
                    } else if (data.message) {
                        errorMsg = data.message;
                    }
                    showAlert(alert, errorMsg, 'error');
                    return;
                }

                showAlert(alert, 'Registration successful! Logging in...', 'success');
                
                // Send welcome notification (NEW FEATURE!)
                // Note: This will be sent after login
                setTimeout(async () => {
                    document.getElementById('loginEmail').value = email;
                    document.getElementById('loginPassword').value = password;
                    await handleLogin(new Event('submit'));
                    
                    // Send welcome notification after login
                    setTimeout(() => {
                        sendNotification(
                            'üéâ Welcome to Vehicle Inspection Center!',
                            'Thank you for registering! You can now book appointments for vehicle inspections.',
                            'general'
                        );
                    }, 2000);
                }, 1000);
            } catch (error) {
                showAlert(alert, 'Connection error: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            navigateTo('login');
        }

        // ============= UI SETUP =============
        function setupUI() {
            if (!currentUser) {
                document.getElementById('mainHeader').style.display = 'none';
                return;
            }

            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('userInfo').textContent = `${currentUser.email} (${currentUser.role})`;

            // Show role-specific buttons
            document.getElementById('navDashboard').style.display = currentUser.role !== 'admin' ? 'block' : 'none';
            document.getElementById('navAppointments').style.display = currentUser.role === 'customer' ? 'block' : 'none';
            document.getElementById('navStatus').style.display = currentUser.role === 'customer' ? 'block' : 'none';
            document.getElementById('navInspection').style.display = currentUser.role === 'technician' ? 'block' : 'none';
            document.getElementById('navAdmin').style.display = currentUser.role === 'admin' ? 'block' : 'none';
            
            // Show notification bell (NEW FEATURE!)
            document.getElementById('notificationBell').style.display = 'block';
            
            // Load notifications
            loadNotificationCount();
            // Check for new notifications every 30 seconds
            setInterval(loadNotificationCount, 30000);
        }

        function showAlert(element, message, type) {
            element.textContent = message;
            element.className = `alert ${type}`;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        // ============= NOTIFICATIONS (NEW FEATURE!) =============
        async function loadNotificationCount() {
            if (!currentUser || !currentToken) return;
            
            try {
                const response = await fetch(`${SERVICES.notification}/notifications/user/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notificationBadge');
                    if (data.unread_count > 0) {
                        badge.textContent = data.unread_count;
                        badge.classList.add('active');
                    } else {
                        badge.classList.remove('active');
                    }
                }
            } catch (error) {
                console.log('Could not load notifications:', error);
            }
        }

        async function openNotifications() {
            const modal = document.getElementById('notificationsModal');
            const list = document.getElementById('notificationsList');
            modal.style.display = 'block';
            list.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
            
            try {
                const response = await fetch(`${SERVICES.notification}/notifications/user/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.notifications && data.notifications.length > 0) {
                        list.innerHTML = data.notifications.map(n => `
                            <div style="border-bottom: 1px solid #ddd; padding: 15px; background: ${n.is_read ? 'white' : '#f0f8ff'};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <strong>${n.subject}</strong>
                                        <p style="margin: 5px 0; color: #666;">${n.message}</p>
                                        <small style="color: #999;">${new Date(n.sent_at).toLocaleString()}</small>
                                    </div>
                                    ${!n.is_read ? `<button onclick="markNotificationRead('${n.id}')" style="padding: 5px 10px; font-size: 12px;">Mark Read</button>` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No notifications yet</p>';
                    }
                }
            } catch (error) {
                list.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Error loading notifications</p>';
            }
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        async function markNotificationRead(id) {
            try {
                await fetch(`${SERVICES.notification}/notifications/${id}/mark-read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                openNotifications();
                loadNotificationCount();
            } catch (error) {
                console.log('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                const response = await fetch(`${SERVICES.notification}/notifications/user/${currentUser.id}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    for (const notification of data.notifications) {
                        if (!notification.is_read) {
                            await markNotificationRead(notification.id);
                        }
                    }
                    openNotifications();
                    loadNotificationCount();
                }
            } catch (error) {
                console.log('Error marking all as read:', error);
            }
        }

        async function sendNotification(subject, message, channel = 'general') {
            if (!currentUser) return;
            
            try {
                await fetch(`${SERVICES.notification}/notifications/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        notification_type: 'email',
                        channel: channel,
                        subject: subject,
                        message: message
                    })
                });
                
                // Refresh notification count
                setTimeout(loadNotificationCount, 1000);
            } catch (error) {
                console.log('Could not send notification:', error);
            }
        }

        // ============= FILE UPLOAD (NEW FEATURE!) =============
        let selectedFiles = [];

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [...selectedFiles, ...files];
            displayFilePreview();
        }

        function displayFilePreview() {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = selectedFiles.map((file, index) => {
                const url = URL.createObjectURL(file);
                return `
                    <div class="file-preview-item">
                        <img src="${url}" alt="${file.name}">
                        <button class="remove-file" onclick="removeFile(${index})">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFilePreview();
        }

        async function uploadFiles(appointmentId, inspectionId) {
            if (selectedFiles.length === 0) return [];
            
            const uploadedFiles = [];
            
            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('uploaded_by', currentUser.id);
                formData.append('appointment_id', appointmentId);
                if (inspectionId) {
                    formData.append('inspection_id', inspectionId);
                }
                formData.append('photo_type', 'inspection');
                formData.append('description', `Inspection photo for appointment ${appointmentId}`);
                
                try {
                    const response = await fetch(`${SERVICES.file}/files/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        uploadedFiles.push(data);
                    }
                } catch (error) {
                    console.log('Error uploading file:', error);
                }
            }
            
            // Clear selected files
            selectedFiles = [];
            displayFilePreview();
            
            return uploadedFiles;
        }

        // Setup drag and drop
        document.addEventListener('DOMContentLoaded', () => {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    selectedFiles = [...selectedFiles, ...files.filter(f => f.type.startsWith('image/'))];
                    displayFilePreview();
                });
            }
        });

        // ============= APPOINTMENTS =============
        async function handleBookAppointment(event) {
            event.preventDefault();
            const alert = document.getElementById('appointmentAlert');

            const data = {
                vehicle_type: document.getElementById('vehicleType').value,
                vehicle_registration: document.getElementById('vehicleReg').value,
                vehicle_brand: document.getElementById('vehicleBrand').value,
                vehicle_model: document.getElementById('vehicleModel').value,
                appointment_date: document.getElementById('appointmentDate').value
            };

            try {
                const response = await fetch(`${SERVICES.appointment}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const appointment = await response.json();
                    showAlert(alert, 'Appointment booked successfully!', 'success');
                    
                    // Send notification (NEW FEATURE!)
                    await sendNotification(
                        '‚úÖ Appointment Booked',
                        `Your appointment for ${data.vehicle_brand} ${data.vehicle_model} (${data.vehicle_registration}) has been booked successfully!`,
                        'appointment'
                    );
                    
                    event.target.reset();
                    setTimeout(loadAppointments, 1000);
                } else {
                    const error = await response.json();
                    showAlert(alert, error.detail || 'Failed to book appointment', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        async function loadAppointments() {
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/${currentUser.id}`,
                    {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }
                );

                const appointments = await response.json();
                const list = document.getElementById('appointmentsList');

                if (appointments.length === 0) {
                    list.innerHTML = '<p>No appointments yet.</p>';
                    return;
                }

                list.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Registration</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appointments.map(apt => `
                                <tr>
                                    <td>${apt.vehicle_info.brand} ${apt.vehicle_info.model}</td>
                                    <td>${apt.vehicle_info.registration}</td>
                                    <td>${apt.appointment_date ? new Date(apt.appointment_date).toLocaleString() : new Date(apt.created_at).toLocaleDateString()}</td>
                                    <td><span class="badge ${apt.status}">${apt.status}</span></td>
                                    <td>
                                        ${apt.status === 'pending' ? 
                                            `<button onclick="showPaymentModal('${apt.id}')">üí≥ Pay Now</button>` : 
                                            apt.status === 'confirmed' ? 
                                            '<span style="color: green;">‚úì Paid & Confirmed</span>' :
                                            '<span>-</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // ============= CUSTOMER STATUS (NEW FEATURE!) =============
        async function loadCustomerStatus() {
            const list = document.getElementById('customerStatusList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading your inspection results...</p></div>';
            
            try {
                // Fetch customer's appointments
                const aptResponse = await fetch(
                    `${SERVICES.appointment}/appointments/${currentUser.id}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` } }
                );
                
                if (!aptResponse.ok) {
                    throw new Error('Failed to load appointments');
                }
                
                const appointments = await aptResponse.json();
                
                if (appointments.length === 0) {
                    list.innerHTML = '<p>You have no appointments yet. <a href="#" onclick="navigateTo(\'appointments\')">Book your first appointment</a></p>';
                    return;
                }
                
                // For each appointment, check if there's an inspection
                const appointmentsWithInspections = [];
                
                for (const apt of appointments) {
                    try {
                        // Try to get inspection for this appointment
                        const inspResponse = await fetch(
                            `${SERVICES.inspection}/inspections/appointment/${apt.id}`,
                            { headers: { 'Authorization': `Bearer ${currentToken}` } }
                        );
                        
                        if (inspResponse.ok) {
                            const inspection = await inspResponse.json();
                            appointmentsWithInspections.push({
                                appointment: apt,
                                inspection: inspection,
                                hasInspection: true
                            });
                        } else {
                            // No inspection yet
                            appointmentsWithInspections.push({
                                appointment: apt,
                                inspection: null,
                                hasInspection: false
                            });
                        }
                    } catch (err) {
                        // Error fetching inspection, mark as no inspection
                        appointmentsWithInspections.push({
                            appointment: apt,
                            inspection: null,
                            hasInspection: false
                        });
                    }
                }
                
                // Render the table
                list.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Registration</th>
                                <th>Appointment Date</th>
                                <th>Payment Status</th>
                                <th>Inspection Status</th>
                                <th>Result</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appointmentsWithInspections.map(item => {
                                const apt = item.appointment;
                                const insp = item.inspection;
                                const hasInsp = item.hasInspection;
                                
                                let inspStatus = 'Not inspected yet';
                                let inspBadge = 'pending';
                                let resultText = '-';
                                let resultBadge = '';
                                let actions = '-';
                                
                                if (hasInsp && insp) {
                                    // Determine status display
                                    const statusMap = {
                                        'not_checked': { text: 'Not Checked', badge: 'pending' },
                                        'in_progress': { text: 'In Progress', badge: 'in_progress' },
                                        'passed': { text: 'PASSED ‚úÖ', badge: 'passed' },
                                        'failed': { text: 'FAILED ‚ùå', badge: 'failed' },
                                        'passed_with_minor_issues': { text: 'Passed with Minor Issues ‚ö†Ô∏è', badge: 'passed_with_minor_issues' }
                                    };
                                    
                                    const status = statusMap[insp.final_status] || { text: insp.final_status, badge: 'pending' };
                                    inspStatus = 'Inspected';
                                    inspBadge = 'confirmed';
                                    resultText = status.text;
                                    resultBadge = status.badge;
                                    
                                    // Show details and PDF download for completed inspections
                                    if (insp.final_status !== 'in_progress' && insp.final_status !== 'not_checked') {
                                        actions = `
                                            <button onclick="viewInspectionDetails('${insp.id}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">üëÅÔ∏è View Details</button>
                                            <button onclick="downloadInspectionPDF('${apt.id}')" style="padding: 5px 10px; font-size: 12px; background: #ff6b6b;">üìÑ Download PDF</button>
                                        `;
                                    } else {
                                        actions = '<span style="color: #999;">Inspection in progress</span>';
                                    }
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${apt.vehicle_info.brand} ${apt.vehicle_info.model}</strong> (${apt.vehicle_info.type})</td>
                                        <td><strong>${apt.vehicle_info.registration}</strong></td>
                                        <td>${apt.appointment_date ? new Date(apt.appointment_date).toLocaleString() : new Date(apt.created_at).toLocaleDateString()}</td>
                                        <td><span class="badge ${apt.status}">${apt.status === 'confirmed' ? 'Paid' : 'Pending'}</span></td>
                                        <td><span class="badge ${inspBadge}">${inspStatus}</span></td>
                                        <td><span class="badge ${resultBadge}">${resultText}</span></td>
                                        <td>${actions}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <p style="margin: 0;"><strong>Legend:</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                            ‚Ä¢ <strong>Not inspected yet:</strong> Your vehicle has not been inspected yet<br>
                            ‚Ä¢ <strong>In Progress:</strong> Technician is currently inspecting your vehicle<br>
                            ‚Ä¢ <strong>PASSED:</strong> Your vehicle passed the inspection ‚úÖ<br>
                            ‚Ä¢ <strong>FAILED:</strong> Your vehicle failed the inspection ‚ùå<br>
                            ‚Ä¢ <strong>Passed with Minor Issues:</strong> Your vehicle passed but has minor issues ‚ö†Ô∏è
                        </p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading customer status:', error);
                list.innerHTML = `<p style="color: red;">Error loading inspection results: ${error.message}</p>`;
            }
        }

        let currentInspectionAppointmentId = null;

        async function viewInspectionDetails(inspectionId, appointmentId = null) {
            const modal = document.getElementById('inspectionDetailsModal');
            const content = document.getElementById('inspectionDetailsContent');
            
            modal.style.display = 'block';
            content.innerHTML = '<p style="text-align: center; color: #666;">Loading inspection details...</p>';
            
            try {
                // Fetch inspection details
                const response = await fetch(
                    `${SERVICES.inspection}/inspections/${inspectionId}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` } }
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load inspection details');
                }
                
                const inspection = await response.json();
                currentInspectionAppointmentId = inspection.appointment_id;
                
                // Fetch files for this appointment
                let files = [];
                try {
                    const filesResponse = await fetch(
                        `${SERVICES.file}/files/appointment/${inspection.appointment_id}`,
                        { headers: { 'Authorization': `Bearer ${currentToken}` } }
                    );
                    if (filesResponse.ok) {
                        files = await filesResponse.json();
                    }
                } catch (err) {
                    console.log('Could not load files:', err);
                }
                
                const results = inspection.results || {};
                const notes = inspection.notes || 'No notes provided';
                
                // Status mapping with colors and emojis
                const statusMap = {
                    'not_checked': { text: 'Not Checked', emoji: '‚è≥', color: '#999' },
                    'in_progress': { text: 'In Progress', emoji: 'üîÑ', color: '#ffa500' },
                    'passed': { text: 'PASSED', emoji: '‚úÖ', color: '#4caf50' },
                    'failed': { text: 'FAILED', emoji: '‚ùå', color: '#f44336' },
                    'passed_with_minor_issues': { text: 'Passed with Minor Issues', emoji: '‚ö†Ô∏è', color: '#ff9800' }
                };
                
                const status = statusMap[inspection.final_status] || { text: inspection.final_status, emoji: '', color: '#666' };
                
                // Build detailed HTML
                let detailsHTML = `
                    <div style="padding: 20px;">
                        <!-- Final Status -->
                        <div style="text-align: center; padding: 20px; background: ${status.color}; color: white; border-radius: 8px; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: white;">${status.emoji} ${status.text}</h2>
                        </div>
                        
                        <!-- Inspection Info -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>Inspection ID:</strong> ${inspection.id}</p>
                            <p style="margin: 5px 0;"><strong>Appointment ID:</strong> ${inspection.appointment_id}</p>
                            <p style="margin: 5px 0;"><strong>Inspected At:</strong> ${new Date(inspection.created_at).toLocaleString()}</p>
                        </div>
                        
                        <!-- Item Results -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="border-bottom: 2px solid #1abc9c; padding-bottom: 10px;">üìã Inspection Items</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Item</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(results).length > 0 ? 
                                        Object.entries(results).map(([key, value]) => {
                                            const isPassed = value && (value.toString().toLowerCase() === 'pass' || value.toString().toLowerCase() === 'passed' || value.toString().toLowerCase() === 'yes');
                                            const isFailed = value && (value.toString().toLowerCase() === 'fail' || value.toString().toLowerCase() === 'failed' || value.toString().toLowerCase() === 'no');
                                            const bgColor = isPassed ? '#e8f5e9' : isFailed ? '#ffebee' : '#fff';
                                            const icon = isPassed ? '‚úÖ' : isFailed ? '‚ùå' : '‚ö™';
                                            
                                            return `
                                                <tr style="background: ${bgColor};">
                                                    <td style="padding: 10px; border: 1px solid #ddd; text-transform: capitalize;"><strong>${key.replace(/_/g, ' ')}</strong></td>
                                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${icon} ${value}</td>
                                                </tr>
                                            `;
                                        }).join('')
                                        : '<tr><td colspan="2" style="padding: 20px; text-align: center; color: #999;">No inspection items recorded</td></tr>'
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Notes -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="border-bottom: 2px solid #1abc9c; padding-bottom: 10px;">üìù Inspector Notes</h3>
                            <div style="background: #fffbf0; padding: 15px; border-left: 4px solid #ffa500; border-radius: 4px;">
                                ${notes}
                            </div>
                        </div>
                        
                        <!-- Photos -->
                        ${files.length > 0 ? `
                            <div>
                                <h3 style="border-bottom: 2px solid #1abc9c; padding-bottom: 10px;">üì∑ Inspection Photos (${files.length})</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                    ${files.map(file => `
                                        <div style="position: relative; border: 2px solid #ddd; border-radius: 5px; overflow: hidden; cursor: pointer;" onclick="window.open('${SERVICES.file}/files/${file.id}/download', '_blank')">
                                            <img src="${SERVICES.file}/files/${file.id}/download" 
                                                 style="width: 100%; height: 150px; object-fit: cover;"
                                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23ddd%22 width=%22150%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage%3C/text%3E%3C/svg%3E'">
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 11px; text-align: center;">
                                                Click to view
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<p style="color: #999; text-align: center; padding: 20px;">No photos uploaded for this inspection</p>'}
                    </div>
                `;
                
                content.innerHTML = detailsHTML;
                
            } catch (error) {
                console.error('Error loading inspection details:', error);
                content.innerHTML = `<p style="color: red; text-align: center;">Error loading inspection details: ${error.message}</p>`;
            }
        }

        function closeInspectionDetails() {
            document.getElementById('inspectionDetailsModal').style.display = 'none';
            currentInspectionAppointmentId = null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const inspModal = document.getElementById('inspectionDetailsModal');
            const notifModal = document.getElementById('notificationsModal');
            
            if (event.target == inspModal) {
                closeInspectionDetails();
            }
            if (event.target == notifModal) {
                closeNotifications();
            }
        }

        function downloadCurrentInspectionPDF() {
            if (currentInspectionAppointmentId) {
                downloadInspectionPDF(currentInspectionAppointmentId);
            } else {
                alert('No inspection selected');
            }
        }

        async function downloadInspectionPDF(appointmentId) {
            try {
                const response = await fetch(
                    `${SERVICES.inspection}/inspections/certificate/${appointmentId}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` } }
                );
                
                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }
                
                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inspection_certificate_${appointmentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert(document.getElementById('statusAlert'), 'PDF downloaded successfully!', 'success');
            } catch (error) {
                showAlert(document.getElementById('statusAlert'), 'Error downloading PDF: ' + error.message, 'error');
            }
        }

        // ============= INSPECTION =============
        async function handleSubmitInspection(event) {
            event.preventDefault();
            const alert = document.getElementById('inspectionAlert');

            const results = {
                brakes: document.querySelector('input[name="brakes"]:checked').value,
                lights: document.querySelector('input[name="lights"]:checked').value,
                tires: document.querySelector('input[name="tires"]:checked').value,
                emissions: document.querySelector('input[name="emissions"]:checked').value
            };

            const data = {
                appointment_id: document.getElementById('inspectionAppId').value,
                results: results,
                final_status: document.getElementById('finalStatus').value,
                notes: document.getElementById('inspectionNotes').value
            };

            try {
                const response = await fetch(`${SERVICES.inspection}/inspections/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const inspection = await response.json();
                    
                    // Upload photos if any (NEW FEATURE!)
                    if (selectedFiles.length > 0) {
                        showAlert(alert, 'Uploading photos...', 'info');
                        await uploadFiles(data.appointment_id, inspection.id);
                    }
                    
                    showAlert(alert, 'Inspection submitted successfully!', 'success');
                    
                    // Send notification to VEHICLE OWNER (customer), not technician! (FIXED!)
                    try {
                        // Fetch appointment to get customer details
                        const aptResponse = await fetch(
                            `${SERVICES.appointment}/appointments/details/${data.appointment_id}`,
                            { headers: { 'Authorization': `Bearer ${currentToken}` } }
                        );
                        
                        if (aptResponse.ok) {
                            const appointment = await aptResponse.json();
                            const vehicleOwner = appointment.user_id; // Customer who owns the vehicle
                            
                            // Get customer email from appointment
                            const userResponse = await fetch(
                                `${SERVICES.auth}/users/${vehicleOwner}`,
                                { headers: { 'Authorization': `Bearer ${currentToken}` } }
                            );
                            
                            if (userResponse.ok) {
                                const customerInfo = await userResponse.json();
                                
                                // Send notification to CUSTOMER ONLY
                                const statusEmoji = {
                                    'passed': '‚úÖ',
                                    'failed': '‚ùå',
                                    'in_progress': '‚è≥',
                                    'passed_with_minor_issues': '‚ö†Ô∏è'
                                };
                                
                                await fetch(`${SERVICES.notification}/notifications/send`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${currentToken}`
                                    },
                                    body: JSON.stringify({
                                        user_id: vehicleOwner,
                                        user_email: customerInfo.email,
                                        notification_type: 'email',
                                        channel: 'inspection',
                                        subject: `${statusEmoji[data.final_status] || 'üìã'} Inspection ${data.final_status === 'in_progress' ? 'In Progress' : 'Complete'}`,
                                        message: `Your vehicle inspection (${appointment.vehicle_info.brand} ${appointment.vehicle_info.model} - ${appointment.vehicle_info.registration}) ${data.final_status === 'in_progress' ? 'is in progress' : 'has been completed'}. Status: ${data.final_status.replace(/_/g, ' ').toUpperCase()}`
                                    })
                                });
                            }
                        }
                    } catch (notifError) {
                        console.log('Could not send notification:', notifError);
                    }
                    
                    event.target.reset();
                    selectedFiles = [];
                    displayFilePreview();
                } else {
                    const error = await response.json();
                    showAlert(alert, error.detail || 'Failed to submit inspection', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        // ============= ADMIN =============
        let currentAdminTab = 'users';
        
        function showAdminTab(tab) {
            currentAdminTab = tab;
            
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            
            // Reset button styles
            document.querySelectorAll('[id^="tab"]').forEach(btn => {
                btn.style.background = '#667eea';
            });
            
            // Show selected tab and highlight button
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.background = '#764ba2';
            
            // Load content
            if (tab === 'users') {
                loadAdminUsers();
            } else if (tab === 'logs') {
                loadAdminLogs();
            } else if (tab === 'vehicles') {
                loadAdminVehicles();
            } else if (tab === 'appointments') {
                loadAdminAppointments();
            } else if (tab === 'inspections') {
                loadAdminInspections();
            } else if (tab === 'schedule') {
                loadAdminSchedule();
            }
        }
        
        async function loadAdminDash() {
            // Load users tab by default
            showAdminTab('users');
        }
        
        async function loadAdminUsers() {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const users = await response.json();
                
                if (users.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td><strong>${user.email}</strong></td>
                                        <td><span class="badge ${user.role}">${user.role}</span></td>
                                        <td><small>${new Date(user.created_at).toLocaleDateString()}</small></td>
                                        <td>
                                            <button onclick="showChangeRoleModal('${user.id}', '${user.email}', '${user.role}')" style="padding: 5px 10px; font-size: 12px;">Change Role</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No users found.</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = `<p style="color: red;">Error loading users: ${error.message}</p>`;
            }
        }
        
        let allLogs = []; // Store all logs for filtering
        let filteredLogs = []; // Store filtered logs for pagination
        let currentPage = 1;
        const logsPerPage = 30;
        
        async function loadAdminLogs() {
            const statsDiv = document.getElementById('adminStats');
            const logsDiv = document.getElementById('adminLogs');
            
            statsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            logsDiv.innerHTML = '';
            
            try {
                const logsResponse = await fetch(`${SERVICES.logging}/log/all?limit=500`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const logs = await logsResponse.json();
                allLogs = logs; // Store for filtering
                filteredLogs = logs; // Initially, all logs
                currentPage = 1; // Reset to page 1
                
                renderLogs(filteredLogs);
            } catch (error) {
                statsDiv.innerHTML = `<p style="color: red;">Error loading logs: ${error.message}</p>`;
                console.error('Error loading logs:', error);
            }
        }
        
        function renderLogs(logs) {
            const statsDiv = document.getElementById('adminStats');
            const logsDiv = document.getElementById('adminLogs');
            
            filteredLogs = logs; // Update filtered logs for pagination
            
            const stats = {
                total: logs.length,
                info: logs.filter(l => l.level === 'INFO').length,
                warning: logs.filter(l => l.level === 'WARNING').length,
                error: logs.filter(l => l.level === 'ERROR').length
            };
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h3>${stats.total}</h3>
                    <p>Total Logs</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.info}</h3>
                    <p>Info</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.warning}</h3>
                    <p>Warnings</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.error}</h3>
                    <p>Errors</p>
                </div>
            `;
            
            if (logs.length > 0) {
                const totalPages = Math.ceil(logs.length / logsPerPage);
                const startIndex = (currentPage - 1) * logsPerPage;
                const endIndex = startIndex + logsPerPage;
                const currentLogs = logs.slice(startIndex, endIndex);
                
                logsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <p><strong>Showing ${startIndex + 1}-${Math.min(endIndex, logs.length)} of ${logs.length} log${logs.length !== 1 ? 's' : ''}</strong></p>
                        ${totalPages > 1 ? `
                            <div class="pagination">
                                <button onclick="goToLogPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; First</button>
                                <button onclick="goToLogPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
                                <span style="margin: 0 15px;">Page ${currentPage} of ${totalPages}</span>
                                <button onclick="goToLogPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
                                <button onclick="goToLogPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last &raquo;</button>
                            </div>
                        ` : ''}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Event</th>
                                <th>Level</th>
                                <th>Message</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentLogs.map(log => `
                                <tr>
                                    <td><strong>${log.service}</strong></td>
                                    <td>${log.event}</td>
                                    <td><span class="badge ${log.level.toLowerCase()}">${log.level}</span></td>
                                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${log.message}</td>
                                    <td><small>${new Date(log.timestamp).toLocaleString()}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${totalPages > 1 ? `
                        <div class="pagination" style="margin-top: 20px; text-align: center;">
                            <button onclick="goToLogPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; First</button>
                            <button onclick="goToLogPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
                            <span style="margin: 0 15px;">Page ${currentPage} of ${totalPages}</span>
                            <button onclick="goToLogPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
                            <button onclick="goToLogPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last &raquo;</button>
                        </div>
                    ` : ''}
                `;
            } else {
                logsDiv.innerHTML = '<p>No logs match the current filters.</p>';
            }
        }
        
        function goToLogPage(page) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            currentPage = page;
            renderLogs(filteredLogs);
        }
        
        function applyLogFilters() {
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();
            const serviceFilter = document.getElementById('logServiceFilter').value;
            const levelFilter = document.getElementById('logLevelFilter').value;
            
            let filtered = allLogs;
            
            // Apply search filter
            if (searchText) {
                filtered = filtered.filter(log => 
                    log.message.toLowerCase().includes(searchText) ||
                    log.event.toLowerCase().includes(searchText)
                );
            }
            
            // Apply service filter
            if (serviceFilter) {
                filtered = filtered.filter(log => log.service === serviceFilter);
            }
            
            // Apply level filter
            if (levelFilter) {
                filtered = filtered.filter(log => log.level === levelFilter);
            }
            
            currentPage = 1; // Reset to page 1 when filtering
            renderLogs(filtered);
        }
        
        function clearLogFilters() {
            document.getElementById('logSearchInput').value = '';
            document.getElementById('logServiceFilter').value = '';
            document.getElementById('logLevelFilter').value = '';
            currentPage = 1; // Reset to page 1
            renderLogs(allLogs);
        }
        
        async function loadAdminVehicles() {
            const container = document.getElementById('adminVehiclesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading vehicles...</p></div>';
            
            try {
                // Fetch ALL vehicles from appointments, not just inspected ones
                const response = await fetch(`${SERVICES.appointment}/appointments/admin/all-vehicles?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch vehicles: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.vehicles && data.vehicles.length > 0) {
                    // Calculate statistics
                    const stats = {
                        total: data.vehicles.length,
                        pending: data.vehicles.filter(v => v.status === 'pending').length,
                        confirmed: data.vehicles.filter(v => v.status === 'confirmed').length,
                        not_checked: data.vehicles.filter(v => v.inspection_status === 'not_checked').length,
                        inspected: data.vehicles.filter(v => v.inspection_status !== 'not_checked').length
                    };
                    
                    container.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>Total Vehicles:</strong> ${stats.total}</p>
                            <p style="margin: 5px 0;"><strong>Payment Status:</strong> Pending: ${stats.pending}, Confirmed: ${stats.confirmed}</p>
                            <p style="margin: 5px 0;"><strong>Inspection Status:</strong> Not Checked: ${stats.not_checked}, Inspected: ${stats.inspected}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Registration</th>
                                    <th>Vehicle</th>
                                    <th>User ID</th>
                                    <th>Appointment Date</th>
                                    <th>Payment Status</th>
                                    <th>Inspection Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.vehicles.map(vehicle => `
                                    <tr>
                                        <td><strong>${vehicle.vehicle_info.registration}</strong></td>
                                        <td>${vehicle.vehicle_info.brand} ${vehicle.vehicle_info.model} (${vehicle.vehicle_info.type})</td>
                                        <td><small>${vehicle.user_id}</small></td>
                                        <td><small>${vehicle.appointment_date ? new Date(vehicle.appointment_date).toLocaleString() : 'Not scheduled'}</small></td>
                                        <td><span class="badge ${vehicle.status}">${vehicle.status}</span></td>
                                        <td><span class="badge ${vehicle.inspection_status}">${vehicle.inspection_status.replace('_', ' ')}</span></td>
                                        <td><small>${new Date(vehicle.created_at).toLocaleDateString()}</small></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No vehicles found in the system.</p>';
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p style="color: red;">Error loading vehicles: ${error.message}</p>`;
            }
        }
        
        async function loadAdminAppointments() {
            const container = document.getElementById('adminAppointmentsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${SERVICES.appointment}/appointments/all`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server returned ${response.status}`);
                }
                
                const appointments = await response.json();
                
                if (Array.isArray(appointments) && appointments.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Vehicle</th>
                                    <th>Registration</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appointments.map(apt => `
                                    <tr>
                                        <td><small>${apt.user_id}</small></td>
                                        <td>${apt.vehicle_info.brand} ${apt.vehicle_info.model}</td>
                                        <td><strong>${apt.vehicle_info.registration}</strong></td>
                                        <td><small>${apt.appointment_date ? new Date(apt.appointment_date).toLocaleString() : 'Not scheduled'}</small></td>
                                        <td><span class="badge ${apt.status}">${apt.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No appointments found.</p>';
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                container.innerHTML = `<p style="color: red;">Error loading appointments: ${error.message}</p>`;
            }
        }
        
        async function loadAdminInspections() {
            const container = document.getElementById('adminInspectionsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                // Fetch all inspections
                const response = await fetch(`${SERVICES.inspection}/admin/inspections/all`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load inspections');
                }
                
                const data = await response.json();
                const inspections = data.inspections || [];
                
                if (inspections.length === 0) {
                    container.innerHTML = '<p>No inspections found yet.</p>';
                    return;
                }
                
                // Render table
                container.innerHTML = `
                    <p style="margin-bottom: 15px;"><strong>Total Inspections:</strong> ${inspections.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Inspection ID</th>
                                <th>Appointment ID</th>
                                <th>Final Status</th>
                                <th>Results</th>
                                <th>Notes</th>
                                <th>Inspected At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inspections.map(insp => {
                                const statusMap = {
                                    'not_checked': { text: 'Not Checked', badge: 'pending' },
                                    'in_progress': { text: 'In Progress', badge: 'in_progress' },
                                    'passed': { text: 'PASSED ‚úÖ', badge: 'passed' },
                                    'failed': { text: 'FAILED ‚ùå', badge: 'failed' },
                                    'passed_with_minor_issues': { text: 'Passed with Minor Issues ‚ö†Ô∏è', badge: 'passed_with_minor_issues' }
                                };
                                
                                const status = statusMap[insp.final_status] || { text: insp.final_status, badge: 'pending' };
                                const results = insp.results || {};
                                const resultsText = Object.entries(results)
                                    .map(([key, value]) => `${key}: ${value}`)
                                    .join(', ') || '-';
                                
                                return `
                                    <tr>
                                        <td><small>${insp.id.substring(0, 8)}...</small></td>
                                        <td><small>${insp.appointment_id.substring(0, 8)}...</small></td>
                                        <td><span class="badge ${status.badge}">${status.text}</span></td>
                                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${resultsText}</td>
                                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${insp.notes || '-'}</td>
                                        <td><small>${new Date(insp.created_at).toLocaleString()}</small></td>
                                        <td>
                                            <button onclick="viewAdminInspectionDetails('${insp.id}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">üëÅÔ∏è View</button>
                                            ${(insp.final_status !== 'in_progress' && insp.final_status !== 'not_checked') ? 
                                                `<button onclick="downloadInspectionPDF('${insp.appointment_id}')" style="padding: 5px 10px; font-size: 12px; background: #ff6b6b;">üìÑ PDF</button>` : 
                                                ''
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading inspections:', error);
                container.innerHTML = `<p style="color: red;">Error loading inspections: ${error.message}</p>`;
            }
        }
        
        async function viewAdminInspectionDetails(inspectionId) {
            // Use the same modal as customer/technician view
            await viewInspectionDetails(inspectionId);
        }
        
        async function loadAdminSchedule() {
            const container = document.getElementById('adminScheduleView');
            const today = new Date();
            const dayOfWeek = today.getDay() || 7;
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - (dayOfWeek - 1));
            const startDateStr = startDate.toISOString().split('T')[0];
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading schedule...</p></div>';
            
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/weekly-schedule?start_date=${startDateStr}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` }}
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const schedule = await response.json();
                
                if (!schedule || !schedule.days || !Array.isArray(schedule.days)) {
                    throw new Error('Invalid schedule data received from server');
                }
                
                // Generate schedule view for admin
                container.innerHTML = `
                    <h4>üìÖ Current Week Schedule</h4>
                    <p style="margin-bottom: 20px; color: #666;">Working hours: ${schedule.working_hours}</p>
                    
                    <div style="overflow-x: auto;">
                        <table style="min-width: 100%;">
                            <thead>
                                <tr>
                                    ${schedule.days.map(day => `
                                        <th style="text-align: center;">
                                            <strong>${day.day_name}</strong><br/>
                                            <small>${new Date(day.date).toLocaleDateString()}</small><br/>
                                            <span style="color: #4caf50; font-size: 12px;">${day.available_count} available</span>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${generateAdminScheduleGrid(schedule)}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                        <p style="margin: 0; color: #2e7d32;"><strong>Legend:</strong></p>
                        <p style="margin: 5px 0; color: #2e7d32;">üü¢ Available slot | üî¥ Booked slot</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading admin schedule:', error);
                container.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Unable to Load Schedule</h4>
                        <p style="color: #856404;"><strong>Error:</strong> ${error.message}</p>
                        <button onclick="loadAdminSchedule()" style="margin-top: 10px;">üîÑ Retry</button>
                    </div>
                `;
            }
        }
        
        function generateAdminScheduleGrid(schedule) {
            if (!schedule.days || schedule.days.length === 0) return '<tr><td colspan="7" style="text-align: center;">No data</td></tr>';
            
            // Show all slots (available and booked) for admin view
            let html = '<tr>';
            
            schedule.days.forEach(day => {
                html += '<td style="vertical-align: top; padding: 15px;">';
                
                if (day.slots && day.slots.length > 0) {
                    day.slots.forEach(slot => {
                        const bgColor = slot.available ? '#e8f5e9' : '#ffebee';
                        const borderColor = slot.available ? '#4caf50' : '#f44336';
                        const icon = slot.available ? 'üü¢' : 'üî¥';
                        
                        html += `
                            <div style="
                                background: ${bgColor};
                                border: 1px solid ${borderColor};
                                padding: 6px 10px;
                                margin-bottom: 6px;
                                border-radius: 4px;
                                text-align: center;
                                font-size: 13px;
                            ">
                                ${icon} ${slot.display}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #999; text-align: center; padding: 20px;">No slots</div>';
                }
                
                html += '</td>';
            });
            
            html += '</tr>';
            return html;
        }
        
        // User Management Modals
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }
        
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('newTechEmail').value = '';
            document.getElementById('newTechPassword').value = '';
            document.getElementById('newTechFirstName').value = '';
            document.getElementById('newTechLastName').value = '';
            document.getElementById('newTechBirthdate').value = '';
            document.getElementById('newTechCountry').value = '';
            document.getElementById('newTechState').value = '';
            document.getElementById('newTechIdNumber').value = '';
        }
        
        async function handleCreateTechnician(event) {
            event.preventDefault();
            const alert = document.getElementById('createUserAlert');
            
            const email = document.getElementById('newTechEmail').value;
            const password = document.getElementById('newTechPassword').value;
            const firstName = document.getElementById('newTechFirstName').value;
            const lastName = document.getElementById('newTechLastName').value;
            const birthdate = document.getElementById('newTechBirthdate').value;
            const country = document.getElementById('newTechCountry').value;
            const state = document.getElementById('newTechState').value;
            const idNumber = document.getElementById('newTechIdNumber').value;
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users/create-technician`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ 
                        email, 
                        password,
                        first_name: firstName,
                        last_name: lastName,
                        birthdate,
                        country,
                        state,
                        id_number: idNumber
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(alert, '‚úÖ Technician created successfully!', 'success');
                    setTimeout(() => {
                        closeCreateUserModal();
                        loadAdminUsers();
                    }, 2000);
                } else {
                    showAlert(alert, data.detail || 'Failed to create technician', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }
        
        function showChangeRoleModal(userId, email, currentRole) {
            const content = document.getElementById('changeRoleContent');
            const newRole = currentRole === 'customer' ? 'technician' : 'customer';
            
            content.innerHTML = `
                <p><strong>User:</strong> ${email}</p>
                <p><strong>Current Role:</strong> <span class="badge ${currentRole}">${currentRole}</span></p>
                <p style="margin: 20px 0;">Change role to: <span class="badge ${newRole}">${newRole}</span></p>
                <button onclick="changeUserRole('${userId}', '${newRole}')" style="width: 100%;">Confirm Change</button>
            `;
            
            document.getElementById('changeRoleModal').style.display = 'block';
        }
        
        function closeChangeRoleModal() {
            document.getElementById('changeRoleModal').style.display = 'none';
        }
        
        async function changeUserRole(userId, newRole) {
            const alert = document.getElementById('changeRoleAlert');
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(alert, '‚úÖ Role changed successfully!', 'success');
                    setTimeout(() => {
                        closeChangeRoleModal();
                        loadAdminUsers();
                    }, 2000);
                } else {
                    showAlert(alert, data.detail || 'Failed to change role', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        // ============= DASHBOARD =============
        async function loadDashboard() {
            const content = document.getElementById('dashboardContent');
            
            if (currentUser.role === 'customer') {
                loadCustomerDashboard();
            } else if (currentUser.role === 'technician') {
                loadTechnicianVehicles();
            }
        }

        async function loadCustomerDashboard() {
            const content = document.getElementById('dashboardContent');
            const today = new Date();
            const dayOfWeek = today.getDay() || 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + 1);
            const startDate = monday.toISOString().split('T')[0];
            
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading schedule...</p></div>';
            
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/weekly-schedule?start_date=${startDate}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` }}
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('Schedule API error:', errorData);
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const schedule = await response.json();
                console.log('Schedule loaded:', schedule);
                
                // Check if schedule has proper structure
                if (!schedule || !schedule.days || !Array.isArray(schedule.days)) {
                    console.error('Invalid schedule structure:', schedule);
                    throw new Error('Invalid schedule data received from server');
                }
                
                // Generate schedule showing only available slots (like French CT website)
                content.innerHTML = `
                    <h2>üìÖ Available Inspection Slots This Week</h2>
                    <p style="margin-bottom: 20px;">Working hours: ${schedule.working_hours} | Click on a slot to book</p>
                    
                    <div style="overflow-x: auto;">
                        <table style="min-width: 100%;">
                            <thead>
                                <tr>
                                    ${schedule.days.map(day => `
                                        <th style="text-align: center;">
                                            <strong>${day.day_name}</strong><br/>
                                            <small>${new Date(day.date).toLocaleDateString()}</small>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${generateAvailableSlotsGrid(schedule)}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="navigateTo('appointments')" style="padding: 15px 30px; font-size: 16px;">
                            üìã Book New Appointment
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading schedule:', error);
                content.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Unable to Load Schedule</h3>
                        <p style="color: #856404;"><strong>Error:</strong> ${error.message}</p>
                        <p style="color: #666;">Please check:</p>
                        <ul style="color: #666;">
                            <li>The appointment service is running on port 8002</li>
                            <li>You have a valid authentication token</li>
                            <li>Your internet connection is stable</li>
                        </ul>
                        <button onclick="loadCustomerDashboard()" style="margin-top: 10px;">üîÑ Retry</button>
                        <p style="margin-top: 15px; font-size: 12px; color: #999;">Check browser console (F12) for detailed error information.</p>
                    </div>
                `;
            }
        }

        function generateAvailableSlotsGrid(schedule) {
            if (!schedule.days || schedule.days.length === 0) return '<tr><td colspan="7" style="text-align: center;">No data</td></tr>';
            
            // Only show available slots for each day (like French CT website)
            let html = '<tr>';
            
            schedule.days.forEach(day => {
                const availableSlots = day.slots.filter(s => s.available);
                
                html += '<td style="vertical-align: top; padding: 15px;">';
                
                if (availableSlots.length > 0) {
                    availableSlots.forEach(slot => {
                        html += `
                            <div style="
                                background: #e8f5e9;
                                border: 1px solid #4caf50;
                                padding: 8px 12px;
                                margin-bottom: 8px;
                                border-radius: 5px;
                                text-align: center;
                                cursor: pointer;
                                font-weight: 500;
                            " 
                            onclick="selectTimeSlot('${slot.time}')">
                                ${slot.display}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #999; text-align: center; padding: 20px;">No slots</div>';
                }
                
                html += '</td>';
            });
            
            html += '</tr>';
            return html;
        }
        
        function selectTimeSlot(slotTime) {
            // Pre-fill the appointment form with selected time
            const dateInput = document.getElementById('appointmentDate');
            if (dateInput) {
                dateInput.value = slotTime;
            }
            navigateTo('appointments');
        }

        async function loadTechnicianVehicles() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading vehicles...</p></div>';
            
            try {
                const response = await fetch(`${SERVICES.inspection}/inspections/vehicles-for-inspection`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (data.vehicles && data.vehicles.length > 0) {
                    content.innerHTML = `
                        <h2>üöó All Vehicles for Inspection</h2>
                        <p style="margin-bottom: 20px;">Total: <strong>${data.total_count}</strong> vehicles | Not Checked: <strong>${data.by_status.not_checked}</strong> | In Progress: <strong>${data.by_status.in_progress}</strong></p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Registration</th>
                                    <th>Vehicle</th>
                                    <th>Appointment Time</th>
                                    <th>Payment Status</th>
                                    <th>Inspection Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.vehicles.map(v => `
                                    <tr>
                                        <td><strong>${v.vehicle_info.registration}</strong></td>
                                        <td>${v.vehicle_info.brand} ${v.vehicle_info.model} (${v.vehicle_info.type})</td>
                                        <td>${v.appointment_time}</td>
                                        <td>${v.payment_status_display || '‚è≥ Pending'}</td>
                                        <td><span class="badge ${v.status}">${v.status_display}</span></td>
                                        <td>
                                            ${v.status === 'not_checked' || v.status === 'in_progress' ? 
                                                `<button onclick="startInspection('${v.appointment_id}')">üîß Inspect</button>` : 
                                                `<button onclick="viewInspectionByAppointment('${v.appointment_id}')" style="background: #4caf50;">üëÅÔ∏è View</button>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    content.innerHTML = '<p>No vehicles for inspection yet.</p>';
                }
            } catch (error) {
                content.innerHTML = `<p style="color: red;">Error loading vehicles: ${error.message}</p>`;
            }
        }

        function startInspection(appointmentId) {
            document.getElementById('inspectionAppId').value = appointmentId;
            navigateTo('inspection');
        }

        async function viewInspectionByAppointment(appointmentId) {
            try {
                // Fetch inspection by appointment ID
                const response = await fetch(
                    `${SERVICES.inspection}/inspections/appointment/${appointmentId}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` } }
                );
                
                if (response.ok) {
                    const inspection = await response.json();
                    await viewInspectionDetails(inspection.id, appointmentId);
                } else {
                    alert('Could not find inspection for this appointment');
                }
            } catch (error) {
                alert('Error loading inspection: ' + error.message);
            }
        }

        // ============= PAYMENT =============
        let currentPaymentAppointmentId = null;

        function showPaymentModal(appointmentId) {
            currentPaymentAppointmentId = appointmentId;
            document.getElementById('paymentAppointmentId').textContent = appointmentId;
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentAppointmentId = null;
        }

        async function processPayment() {
            const alert = document.getElementById('paymentAlert');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                // Check if payment service is available
                console.log('Initiating payment for appointment:', currentPaymentAppointmentId);
                
                // Create payment
                const createResponse = await fetch(`${SERVICES.payment}/payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        appointment_id: currentPaymentAppointmentId,
                        amount: 50.00
                    })
                });
                
                const createData = await createResponse.json();
                console.log('‚úì Payment creation response:', createResponse.status, createData);
                
                if (!createResponse.ok) {
                    const errorMsg = createData.detail || `Payment creation failed (${createResponse.status})`;
                    console.error('Payment creation error:', errorMsg);
                    showAlert(alert, errorMsg, 'error');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ Confirm Payment (Simulated)';
                    return;
                }
                
                console.log('‚úì Payment created, confirming...');
                
                // Confirm payment (simulated)
                const confirmResponse = await fetch(
                    `${SERVICES.payment}/payment/${createData.id}/confirm-simulated`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }
                );
                
                const confirmData = await confirmResponse.json();
                console.log('‚úì Payment confirmation response:', confirmResponse.status, confirmData);
                
                if (confirmResponse.ok) {
                    console.log('‚úì Payment confirmed successfully!');
                    showAlert(alert, '‚úÖ Payment successful! Appointment confirmed.', 'success');
                    
                    // Send notification (NEW FEATURE!)
                    await sendNotification(
                        'üí∞ Payment Confirmed',
                        'Your payment has been processed successfully. Your appointment is now confirmed!',
                        'payment'
                    );
                    
                    setTimeout(() => {
                        closePaymentModal();
                        if (currentUser.role === 'customer') {
                            loadAppointments();
                        }
                    }, 2000);
                } else {
                    const errorMsg = confirmData.detail || `Payment confirmation failed (${confirmResponse.status})`;
                    console.error('Payment confirmation error:', errorMsg);
                    showAlert(alert, errorMsg, 'error');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ Confirm Payment (Simulated)';
                }
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                const errorMsg = error.message.includes('Failed to fetch') 
                    ? 'Cannot connect to payment service. Please ensure all services are running.' 
                    : error.message;
                showAlert(alert, 'Error: ' + errorMsg, 'error');
                btn.disabled = false;
                btn.textContent = '‚úÖ Confirm Payment (Simulated)';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target == modal) {
                closePaymentModal();
            }
        }

        // ============= INITIALIZATION =============
        window.addEventListener('load', async () => {
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');

            if (savedToken && savedUser) {
                // Verify token is still valid
                try {
                    const response = await fetch(`${SERVICES.auth}/verify`, {
                        headers: { 'Authorization': `Bearer ${savedToken}` }
                    });
                    
                    if (response.ok) {
                        currentToken = savedToken;
                        currentUser = JSON.parse(savedUser);
                        setupUI();
                        navigateTo('dashboard');
                    } else {
                        // Token invalid, clear and show login
                        console.log('Stored token is invalid, clearing...');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        navigateTo('login');
                    }
                } catch (error) {
                    // If verification fails, clear storage
                    console.log('Error verifying token, clearing...');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    navigateTo('login');
                }
            } else {
                navigateTo('login');
            }
        });
    </script>
</body>
</html>